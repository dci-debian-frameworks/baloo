From 13ac6feef102a3c9fd1b81c34666e55aa4d05a34 Mon Sep 17 00:00:00 2001
From: Vishesh Handa <me@vhanda.in>
Date: Tue, 1 Apr 2014 18:51:52 +0200
Subject: [PATCH 34/56] FileIndexer: Sync the config file after initial
 indexing

---
 src/file/fileindexer.cpp       | 7 ++++++-
 src/file/fileindexer.h         | 1 +
 src/file/fileindexerconfig.cpp | 1 +
 3 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/src/file/fileindexer.cpp b/src/file/fileindexer.cpp
index e5f959e..7ac3f1d 100644
--- a/src/file/fileindexer.cpp
+++ b/src/file/fileindexer.cpp
@@ -57,6 +57,8 @@ FileIndexer::FileIndexer(Database* db, FileIndexerConfig* config, QObject* paren
                        QDBusConnection::ExportScriptableSignals |
                        QDBusConnection::ExportScriptableSlots |
                        QDBusConnection::ExportAdaptors);
+
+    m_initalRun = m_config->isInitialRun();
 }
 
 FileIndexer::~FileIndexer()
@@ -77,7 +79,10 @@ void FileIndexer::update()
 
 void FileIndexer::slotBasicIndexingDone()
 {
-    m_config->setInitialRun(false);
+    if (m_initalRun) {
+        m_config->setInitialRun(false);
+        m_initalRun = false;
+    }
 }
 
 QString FileIndexer::statusMessage() const
diff --git a/src/file/fileindexer.h b/src/file/fileindexer.h
index f594e9a..70a228f 100644
--- a/src/file/fileindexer.h
+++ b/src/file/fileindexer.h
@@ -97,6 +97,7 @@ private:
     IndexScheduler* m_indexScheduler;
     FileIndexerConfig* m_config;
     bool m_startupUpdateDone;
+    bool m_initalRun;
 };
 }
 
diff --git a/src/file/fileindexerconfig.cpp b/src/file/fileindexerconfig.cpp
index 02ea0f0..ad4c298 100644
--- a/src/file/fileindexerconfig.cpp
+++ b/src/file/fileindexerconfig.cpp
@@ -444,6 +444,7 @@ bool FileIndexerConfig::forceConfigUpdate()
 void FileIndexerConfig::setInitialRun(bool isInitialRun)
 {
     m_config.group("General").writeEntry("first run", isInitialRun);
+    m_config.sync();
 }
 
 bool FileIndexerConfig::initialUpdateDisabled() const
-- 
1.9.1

